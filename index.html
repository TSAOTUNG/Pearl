<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å°çç çš„æ—¥å¸¸</title>
    
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="icon" href="./icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFFDF5; color: #5D5D5D; -webkit-tap-highlight-color: transparent; }
        .cream-card { background-color: #FFFFFF; border: 1px solid #F0E6D2; box-shadow: 0 4px 10px -2px rgba(230, 210, 181, 0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #D4C0A1; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(5%); } }

        /* è¦–è¦ºè¨­å®š */
        .banner-img { object-position: center 40%; }
        /* èª¿æ•´åœ–ç‰‡å°ç„¦é» */
        .avatar-img { object-position: 0% 25%; }
        .empty-avatar-img { object-position: 0% 25%; }
        
        /* iOS è¼¸å…¥æ¡†å„ªåŒ– */
        .input-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #FAF7F0; 
            border: 1px solid #EBE0D0;
            border-radius: 0.75rem;
            height: 3rem;
            position: relative;
        }
        
        .ios-input-fix {
            background: transparent;
            border: none;
            width: 100%;
            height: 100%;
            text-align: center;
            text-align-last: center;
            font-size: 16px;
            appearance: none;
            -webkit-appearance: none;
            padding: 0;
            margin: 0;
            padding-top: 4px; 
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 500;
            color: #5D5D5D;
        }

        /* Modal å‹•ç•« */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-enter-active .modal-content, .modal-leave-active .modal-content { transition: transform 0.3s ease; }
        .modal-enter-from .modal-content, .modal-leave-to .modal-content { transform: translateY(20px) scale(0.95); }
    </style>
</head>
<body class="min-h-screen pb-24">

<div id="app">
    <div v-if="isLoading" class="fixed inset-0 bg-[#FFFDF5] z-50 flex items-center justify-center flex-col transition-opacity duration-300">
        <img src="./record.JPG" class="w-24 h-24 mb-4 rounded-full shadow-sm animate-[bounce_1s_infinite] object-cover avatar-img">
        <div class="loader mb-2"></div>
        <p class="text-xs text-[#8C7B66] font-medium tracking-widest">è³‡æ–™åŒæ­¥ä¸­...</p>
    </div>

    <transition name="modal">
        <div v-if="isEditModalOpen" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center bg-black/60 backdrop-blur-sm p-4" @click.self="isEditModalOpen = false">
            <div class="modal-content bg-white w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar relative">
                <button @click="isEditModalOpen = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                <h3 class="text-lg font-bold text-[#8C7B66] mb-4 flex items-center"><i class="fas fa-edit mr-2"></i>ä¿®æ”¹ç´€éŒ„</h3>

                <div class="space-y-4">
                    <div v-if="editForm.category === 'excretion'">
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">æ™‚é–“</label>
                            <div class="input-wrapper"><input type="datetime-local" v-model="editForm.data.datetime" class="ios-input-fix"></div>
                        </div>
                        <div class="flex space-x-4 mb-4">
                            <label class="flex-1 cursor-pointer group">
                                <input type="radio" v-model="editForm.data.type" value="poop" class="hidden peer">
                                <div class="py-3 text-center rounded-xl border border-gray-200 peer-checked:bg-[#E6D2B5] peer-checked:text-white transition"><div class="text-xl">ğŸ’©</div><div class="text-xs">ä¾¿ä¾¿</div></div>
                            </label>
                            <label class="flex-1 cursor-pointer group">
                                <input type="radio" v-model="editForm.data.type" value="pee" class="hidden peer">
                                <div class="py-3 text-center rounded-xl border border-gray-200 peer-checked:bg-[#E6D2B5] peer-checked:text-white transition"><div class="text-xl">ğŸ’§</div><div class="text-xs">å°¿å°¿</div></div>
                            </label>
                        </div>
                    </div>

                    <div v-if="editForm.category === 'food'">
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">æ”¾é£¯æ™‚é–“</label>
                            <div class="input-wrapper"><input type="datetime-local" v-model="editForm.data.startTime" class="ios-input-fix"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">ç¨®é¡</label>
                                <div class="input-wrapper"><select v-model="editForm.data.type" class="ios-input-fix"><option value="dry">ä¹¾ç³§</option><option value="wet">æ¿•ç³§</option><option value="snack">é»å¿ƒ</option></select></div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">çµ¦äºˆ (g)</label>
                                <div class="input-wrapper"><input type="number" v-model.number="editForm.data.amountGiven" class="ios-input-fix"></div>
                            </div>
                        </div>
                        <div class="mb-4">
                             <label class="block text-xs font-bold text-gray-400 uppercase mb-1">å“ç‰Œ</label>
                             <div class="input-wrapper"><input type="text" v-model="editForm.data.brand" class="ios-input-fix"></div>
                        </div>
                        <div class="mb-4" v-if="editForm.data.status === 'finished'">
                             <label class="block text-xs font-bold text-gray-400 uppercase mb-1">å‰©é¤˜ (g)</label>
                             <div class="input-wrapper"><input type="number" v-model.number="editForm.data.amountLeft" class="ios-input-fix"></div>
                        </div>
                        <div v-if="editForm.data.status === 'finished'" class="mb-2">
                             <label class="block text-xs font-bold text-gray-400 uppercase mb-1">å®Œé£Ÿæ™‚é–“</label>
                             <div class="input-wrapper"><input type="datetime-local" v-model="editForm.data.endTime" class="ios-input-fix"></div>
                        </div>
                    </div>

                    <div v-if="editForm.category === 'meds'">
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">æ—¥æœŸ</label>
                            <div class="input-wrapper"><input type="date" v-model="editForm.data.date" class="ios-input-fix"></div>
                        </div>
                        <div class="mb-4">
                             <label class="block text-xs font-bold text-gray-400 uppercase mb-1">å“ç‰Œ</label>
                             <div class="input-wrapper"><input type="text" v-model="editForm.data.brand" class="ios-input-fix"></div>
                        </div>
                    </div>

                    <button @click="submitEdit" class="w-full py-3 bg-[#8C7B66] text-white rounded-xl shadow-md hover:bg-[#7A6A56] transition font-bold">ç¢ºèªä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </transition>

    <header class="relative bg-white shadow-sm pb-4 rounded-b-[2rem] overflow-hidden z-10">
        <div class="h-52 w-full overflow-hidden relative bg-[#E6D2B5]">
            <img src="./banner.jpg" onerror="this.style.display='none'" alt="å°çç ç¡è¦º" class="w-full h-full object-cover banner-img opacity-95">
            <div class="absolute inset-0 bg-gradient-to-t from-white/80 via-transparent to-transparent"></div>
        </div>
        <div class="pl-12 pr-6 -mt-16 flex items-end space-x-4 relative">
            <div class="w-28 h-28 rounded-full border-4 border-white shadow-md overflow-hidden bg-[#FFFDF5]">
                <img src="./avatar.jpg" alt="å°çç " class="w-full h-full object-cover avatar-img">
            </div>
            <div class="mb-2">
                <h1 class="text-2xl font-bold tracking-wide text-gray-800">å°çç </h1>
                <p class="text-xs text-gray-500 mt-1 bg-white/60 px-2 py-1 rounded-full inline-block backdrop-blur-sm">
                    <i class="fas fa-birthday-cake text-yellow-500 mr-1"></i>2025/6/28 <span class="mx-1 opacity-50">|</span> <i class="fas fa-heart text-red-400 mr-1"></i>Yvonne
                </p>
            </div>
        </div>
    </header>

    <nav class="flex justify-around items-center px-4 py-3 mt-2 sticky top-0 bg-[#FFFDF5]/95 backdrop-blur-sm z-20 border-b border-stone-100">
        <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" 
            :class="['flex flex-col items-center space-y-1 transition-all w-16', currentTab === tab.id ? 'text-[#8C7B66] scale-105' : 'text-gray-300 hover:text-gray-400']">
            <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-lg transition-colors', currentTab === tab.id ? 'bg-[#E6D2B5] text-white shadow-md' : 'bg-transparent']">
                <i :class="['fas', tab.icon]"></i>
            </div>
            <span class="text-[11px] font-medium tracking-wide">{{ tab.name }}</span>
        </button>
    </nav>

    <main class="px-5 mt-4 transition-all duration-300">
        
        <div v-if="currentTab === 'excretion'" class="space-y-4 animate-fade-in">
            <div class="cream-card p-6 rounded-2xl">
                <h2 class="text-lg font-bold mb-5 text-[#8C7B66] flex items-center"><i class="fas fa-poop mr-2"></i>ä¾¿æººè¨˜éŒ„</h2>
                
                <div class="mb-5">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 text-center">æ™‚é–“</label>
                    <div class="input-wrapper">
                        <input type="datetime-local" v-model="form.excretion.datetime" class="ios-input-fix">
                    </div>
                </div>

                <div class="flex space-x-4 mb-5">
                    <label class="flex-1 cursor-pointer group">
                        <input type="radio" v-model="form.excretion.type" value="poop" class="hidden peer">
                        <div class="py-4 text-center rounded-xl border border-gray-200 peer-checked:bg-[#E6D2B5] peer-checked:text-white peer-checked:border-[#E6D2B5] transition-all"><div class="text-2xl mb-1">ğŸ’©</div><div class="text-sm">ä¾¿ä¾¿</div></div>
                    </label>
                    <label class="flex-1 cursor-pointer group">
                        <input type="radio" v-model="form.excretion.type" value="pee" class="hidden peer">
                        <div class="py-4 text-center rounded-xl border border-gray-200 peer-checked:bg-[#E6D2B5] peer-checked:text-white peer-checked:border-[#E6D2B5] transition-all"><div class="text-2xl mb-1">ğŸ’§</div><div class="text-sm">å°¿å°¿</div></div>
                    </label>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 text-center">ç…§ç‰‡ (è‡ªå‹•å£“ç¸®)</label>
                    <div class="relative">
                        <input type="file" @change="handleImageCompress" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"/>
                        <div v-if="!form.excretion.imageBase64" class="w-full h-32 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 bg-gray-50">
                            <i class="fas fa-camera text-2xl mb-2"></i><span class="text-xs">é»æ“Šé¸æ“‡ç…§ç‰‡</span>
                        </div>
                        <div v-else class="w-full h-48 rounded-xl overflow-hidden bg-gray-100 relative shadow-inner">
                            <img :src="form.excretion.imageBase64" class="w-full h-full object-cover">
                            <button @click.stop="form.excretion.imageBase64 = null" class="absolute top-2 right-2 bg-black/50 text-white w-8 h-8 rounded-full z-20"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
                <button @click="submitExcretion" class="w-full py-3.5 bg-[#5D5D5D] text-white rounded-xl shadow-lg hover:bg-[#4A4A4A] transition font-medium tracking-wide">å„²å­˜è¨˜éŒ„</button>
            </div>
        </div>

        <div v-if="currentTab === 'food'" class="space-y-6 animate-fade-in">
            <div v-if="activeMeal" class="cream-card p-6 rounded-2xl border-l-4 border-[#E6D2B5] relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-2 -mr-2 w-16 h-16 bg-[#FFF8E1] rounded-full blur-xl opacity-50"></div>
                <h3 class="text-sm text-[#A68A64] font-bold mb-1">ç›®å‰ç‹€æ…‹ï¼šç”¨é¤ä¸­...</h3>
                <div class="text-2xl font-bold text-gray-700 mb-1">{{ activeMeal.brand }} <span class="text-base font-normal text-gray-500">({{ foodTypeLabels[activeMeal.type] }})</span></div>
                <div class="text-sm text-gray-500 mb-4 flex items-center justify-center"><i class="far fa-clock mr-1"></i> {{ formatTime(activeMeal.startTime) }} <span class="mx-2">|</span> <i class="fas fa-weight-hanging mr-1"></i> {{ activeMeal.amountGiven }}g</div>
                <hr class="border-dashed border-gray-200 my-4">
                <h4 class="text-sm font-bold text-gray-600 mb-3 text-center">æˆ‘è¦æ”¶ç¢— (è¨˜éŒ„å‰©é¤˜)</h4>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1 text-center">æ”¶ç¢—æ™‚é–“</label>
                        <div class="input-wrapper">
                            <input type="time" v-model="form.leftover.time" class="ios-input-fix">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1 text-center">å‰©é¤˜ (g)</label>
                        <div class="input-wrapper">
                            <input type="number" v-model.number="form.leftover.amount" class="ios-input-fix" placeholder="0" style="padding-top:0">
                        </div>
                    </div>
                </div>
                <button @click="submitLeftover" class="w-full py-3 bg-[#8C7B66] text-white rounded-xl shadow-md hover:bg-[#7A6A56] transition">å®Œæˆç”¨é¤</button>
            </div>

            <div class="cream-card p-6 rounded-2xl">
                <h2 class="text-lg font-bold mb-4 text-[#8C7B66] flex items-center justify-between"><span><i class="fas fa-utensils mr-2"></i>æˆ‘è¦æ”¾é£¯</span></h2>
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 text-center">æ”¾é£¯æ™‚é–“</label>
                    <div class="input-wrapper">
                        <input type="datetime-local" v-model="form.food.datetime" class="ios-input-fix">
                    </div>
                </div>

                <div class="flex space-x-2 mb-4 overflow-x-auto no-scrollbar pb-1 justify-center">
                    <button v-for="type in ['dry', 'wet', 'snack']" @click="form.food.type = type" :class="['flex-1 px-4 py-2 rounded-lg text-sm border transition-all whitespace-nowrap', form.food.type === type ? 'bg-[#E6D2B5] border-[#E6D2B5] text-white shadow-sm' : 'border-gray-200 text-gray-400 bg-white']">{{ foodTypeLabels[type] }}</button>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 text-center">å“ç‰Œ</label>
                        <div class="flex space-x-1 input-wrapper px-2">
                            <select v-model="form.food.brand" class="ios-input-fix text-left" style="padding-top:0"><option v-for="opt in getFoodOptions(form.food.type)" :value="opt">{{ opt }}</option></select>
                            <button @click="addFoodOption" class="px-2 text-gray-400">+</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 text-center">çµ¦äºˆ (g)</label>
                        <div class="input-wrapper">
                            <input type="number" v-model.number="form.food.amountGiven" class="ios-input-fix font-bold" style="padding-top:0">
                        </div>
                    </div>
                </div>
                <div v-if="form.food.type !== 'snack'" class="mb-6 bg-[#FAF7F0] p-3 rounded-xl border border-[#F0E6D2]">
                    <div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-gray-500">æ·»åŠ ä¿å¥å“</label><button @click="addSupplementOption" class="text-[10px] text-[#A68A64] border border-[#A68A64] px-1.5 rounded">+ æ–°å¢</button></div>
                    <div class="flex flex-wrap gap-2">
                        <label v-for="supp in settings.supplements" :key="supp" class="inline-flex items-center cursor-pointer select-none">
                            <input type="checkbox" :value="supp" v-model="form.food.supplements" class="hidden peer"><span class="px-3 py-1 rounded-full text-xs bg-white border border-gray-200 text-gray-400 peer-checked:bg-[#E6D2B5] peer-checked:text-white peer-checked:border-[#E6D2B5] transition-all">{{ supp }}</span>
                        </label>
                    </div>
                </div>
                <button @click="submitServeFood" class="w-full py-3.5 bg-[#5D5D5D] text-white rounded-xl shadow-lg hover:bg-[#4A4A4A] transition font-medium">é–‹å§‹æ”¾é£¯</button>
            </div>
        </div>

        <div v-if="currentTab === 'meds'" class="space-y-4 animate-fade-in">
            <div class="cream-card p-6 rounded-2xl">
                <h2 class="text-lg font-bold mb-5 text-[#8C7B66] flex items-center"><i class="fas fa-notes-medical mr-2"></i>é©…èŸ²è¨˜éŒ„</h2>
                
                <div class="mb-5">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 text-center">æ—¥æœŸ</label>
                    <div class="input-wrapper">
                        <input type="date" v-model="form.meds.date" class="ios-input-fix">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 text-center">è—¥å“å“ç‰Œ</label>
                    <div class="input-wrapper">
                        <input type="text" v-model="form.meds.brand" placeholder="ä¾‹å¦‚ï¼šå…¨èƒ½è²“" class="ios-input-fix" style="padding-top:0">
                    </div>
                </div>
                <button @click="submitMeds" class="w-full py-3.5 bg-[#5D5D5D] text-white rounded-xl shadow-lg hover:bg-[#4A4A4A] transition font-medium">å„²å­˜è¨˜éŒ„</button>
            </div>
        </div>

        <div v-if="currentTab === 'history'" class="space-y-4 animate-fade-in pb-12">
            <div class="sticky top-[76px] z-30 bg-[#FFFDF5]/95 backdrop-blur-sm pt-2 pb-4 -mx-5 px-5 border-b border-stone-100">
                <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-3">
                    <button @click="filterCategory = 'all'" :class="['px-3 py-1.5 rounded-full text-xs border whitespace-nowrap', filterCategory === 'all' ? 'bg-gray-800 text-white border-gray-800' : 'bg-white border-gray-200 text-gray-500']">å…¨éƒ¨</button>
                    <button @click="filterCategory = 'excretion'" :class="['px-3 py-1.5 rounded-full text-xs border whitespace-nowrap', filterCategory === 'excretion' ? 'bg-[#E6D2B5] text-white border-[#E6D2B5]' : 'bg-white border-gray-200 text-gray-500']">ä¾¿æºº</button>
                    <button @click="filterCategory = 'food'" :class="['px-3 py-1.5 rounded-full text-xs border whitespace-nowrap', filterCategory === 'food' ? 'bg-[#E6D2B5] text-white border-[#E6D2B5]' : 'bg-white border-gray-200 text-gray-500']">ç”¨é¤</button>
                    <button @click="filterCategory = 'meds'" :class="['px-3 py-1.5 rounded-full text-xs border whitespace-nowrap', filterCategory === 'meds' ? 'bg-[#E6D2B5] text-white border-[#E6D2B5]' : 'bg-white border-gray-200 text-gray-500']">é©…èŸ²</button>
                </div>
                <div class="input-wrapper h-10">
                    <i class="fas fa-calendar-alt text-gray-400 mr-2"></i>
                    <input type="date" v-model="filterDate" class="ios-input-fix w-full" style="padding-top:4px; text-align: left;">
                    <button v-if="filterDate" @click="filterDate = ''" class="ml-2 text-gray-400 px-2"><i class="fas fa-times-circle"></i></button>
                </div>
            </div>

            <div v-if="filteredRecords.length === 0 && !isLoading" class="text-center py-12 opacity-50">
                <img src="./record.JPG" class="w-20 h-20 rounded-full mx-auto mb-3 opacity-50 grayscale object-cover empty-avatar-img">
                <p class="text-gray-400">å°šç„¡ç¬¦åˆçš„è¨˜éŒ„</p>
            </div>

            <div v-for="record in filteredRecords" :key="record.id" class="cream-card p-4 rounded-xl flex items-start space-x-3 relative transition-transform active:scale-[0.99]">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg flex-shrink-0 mt-1" :class="{'bg-yellow-50 text-yellow-600': record.category === 'excretion', 'bg-orange-50 text-orange-600': record.category === 'food', 'bg-blue-50 text-blue-600': record.category === 'meds'}">
                    <i v-if="record.category === 'excretion'" class="fas" :class="record.data.type === 'poop' ? 'fa-poop' : 'fa-tint'"></i>
                    <i v-if="record.category === 'food'" class="fas fa-utensils"></i>
                    <i v-if="record.category === 'meds'" class="fas fa-notes-medical"></i>
                </div>
                <div class="flex-1">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-bold text-gray-400 tracking-wider bg-gray-50 px-2 py-0.5 rounded">{{ formatDate(record.timestamp) }}</span>
                        <div class="flex space-x-2">
                             <button @click.stop="openEditModal(record)" class="text-gray-300 hover:text-[#8C7B66] px-1 transition"><i class="fas fa-pencil-alt"></i></button>
                             <button @click.stop="deleteRecord(record.id)" class="text-gray-200 hover:text-red-400 px-1"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    
                    <div v-if="record.category === 'excretion'">
                        <p class="font-bold text-gray-700 text-sm">{{ record.data.type === 'poop' ? 'æ’ä¾¿' : 'æ’å°¿' }}</p>
                        <div v-if="record.data.imageBase64" class="mt-2 w-24 h-24 rounded-lg overflow-hidden bg-gray-100 border border-gray-100"><img :src="record.data.imageBase64" class="w-full h-full object-cover"></div>
                    </div>
                    <div v-if="record.category === 'food'">
                        <div class="flex justify-between items-center"><p class="font-bold text-gray-700 text-sm">{{ foodTypeLabels[record.data.type] }} <span class="font-normal text-gray-500 ml-1">{{ record.data.brand }}</span></p><span v-if="record.data.status === 'eating'" class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full animate-pulse">ç”¨é¤ä¸­</span><span v-else class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">å·²å®Œé£Ÿ</span></div>
                        <div class="mt-2 text-sm text-gray-600 bg-[#FAF7F0] p-2 rounded-lg text-xs leading-relaxed">
                            <div class="text-[10px] text-gray-400 mb-1 border-b border-gray-200 pb-1 flex justify-between"><span><i class="far fa-clock"></i> {{ formatTime(record.data.startTime) }} æ”¾é£¯</span><span v-if="record.data.endTime"> â” {{ formatTime(record.data.endTime) }} æ”¶ç¢—</span></div>
                            <div class="flex justify-between mt-1"><span>çµ¦äºˆï¼š{{ record.data.amountGiven }}g</span><span v-if="record.data.endTime">å‰©é¤˜ï¼š{{ record.data.amountLeft }}g</span><span v-else class="text-gray-400 italic">å°šæœªæ”¶ç¢—</span></div>
                            <div v-if="record.data.endTime" class="mt-1 pt-1 border-t border-gray-200 font-bold text-[#A68A64]">å…±åƒä¸‹ï¼š{{ record.data.amountGiven - record.data.amountLeft }}g</div>
                        </div>
                        <div v-if="record.data.supplements?.length > 0" class="flex gap-1 mt-2 flex-wrap"><span v-for="s in record.data.supplements" class="text-[10px] border border-gray-200 text-gray-400 px-2 py-0.5 rounded-full">{{ s }}</span></div>
                        <div v-if="record.data.status === 'eating'" class="mt-2"><button @click="quickFinish(record.id)" class="text-xs w-full py-1 bg-[#E6D2B5] text-white rounded">è£œæŒ‰æ”¶ç¢— (è¨­ç‚ºå‰© 0g)</button></div>
                    </div>
                    <div v-if="record.category === 'meds'">
                        <p class="font-bold text-gray-700 text-sm">é«”å…§å¤–é©…èŸ²</p><p class="text-xs text-gray-500 mt-1">å“ç‰Œï¼š{{ record.data.brand }}</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDG2mRZslEFj8-l9on8lZDh2YisuJGoNdk",
        authDomain: "pearl-tracking.firebaseapp.com",
        projectId: "pearl-tracking",
        storageBucket: "pearl-tracking.firebasestorage.app",
        messagingSenderId: "739538396268",
        appId: "1:739538396268:web:88c69eed7d402b4a646449",
        measurementId: "G-GGS823KYKC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const getCurrentDateTime = () => { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); return now.toISOString().slice(0, 16); };
    const getCurrentTime = () => { const now = new Date(); return String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0'); };

    createApp({
        data() {
            return {
                isLoading: true,
                currentTab: 'excretion',
                tabs: [ 
                    { id: 'excretion', name: 'ä¾¿æºº', icon: 'fa-poop' }, 
                    { id: 'food', name: 'ç”¨é¤', icon: 'fa-utensils' }, 
                    { id: 'meds', name: 'é©…èŸ²', icon: 'fa-notes-medical' }, 
                    { id: 'history', name: 'è¨˜éŒ„', icon: 'fa-history' } 
                ],
                foodTypeLabels: { dry: 'ä¹¾ç³§', wet: 'æ¿•ç³§', snack: 'é»å¿ƒ' },
                settings: { dryOptions: ['çš‡å®¶ K36'], wetOptions: ['çš‡å®¶ K36'], supplements: ['é›¢èƒºé…¸', 'ç‰›ç£ºé…¸', 'æ’æ¯›ç²‰'] },
                
                filterDate: '',
                filterCategory: 'all',
                
                // æ–°å¢ï¼šç·¨è¼¯æ¨¡å¼çš„ç‹€æ…‹
                isEditModalOpen: false,
                editForm: { id: null, category: '', data: {} },
                
                form: {
                    excretion: { type: 'poop', datetime: getCurrentDateTime(), imageBase64: null },
                    food: { type: 'dry', brand: 'çš‡å®¶ K36', amountGiven: '', supplements: [], datetime: getCurrentDateTime() },
                    leftover: { time: getCurrentTime(), amount: 0 },
                    meds: { date: new Date().toISOString().split('T')[0], brand: '' }
                },
                records: []
            }
        },
        computed: {
            activeMeal() { 
                const record = this.records.find(r => r.category === 'food' && r.data.status === 'eating');
                if (!record) return null;
                return { id: record.id, ...record.data };
            },
            filteredRecords() {
                let result = this.records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (this.filterDate) {
                    result = result.filter(record => record.timestamp.substring(0, 10) === this.filterDate);
                }
                if (this.filterCategory !== 'all') {
                    result = result.filter(record => record.category === this.filterCategory);
                }
                return result;
            }
        },
        async created() {
            const q = query(collection(db, "records"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => { this.records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); this.isLoading = false; });
            const settingsDoc = await getDoc(doc(db, "config", "general"));
            if (settingsDoc.exists()) { this.settings = settingsDoc.data(); } else { await setDoc(doc(db, "config", "general"), this.settings); }
        },
        methods: {
            getFoodOptions(type) { return type === 'dry' ? this.settings.dryOptions : (type === 'wet' ? this.settings.wetOptions : []); },
            formatDate(isoString) { if(!isoString) return ''; const d = new Date(isoString); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; },
            formatTime(isoString) { if(!isoString) return '--:--'; const d = new Date(isoString); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; },
            async updateSettings() { await setDoc(doc(db, "config", "general"), this.settings); },
            addFoodOption() { const newOpt = prompt("è«‹è¼¸å…¥æ–°å“ç‰Œåç¨±ï¼š"); if (newOpt) { if (this.form.food.type === 'dry') this.settings.dryOptions.push(newOpt); else if (this.form.food.type === 'wet') this.settings.wetOptions.push(newOpt); this.form.food.brand = newOpt; this.updateSettings(); } },
            addSupplementOption() { const newSupp = prompt("è«‹è¼¸å…¥æ–°ä¿å¥å“åç¨±ï¼š"); if (newSupp) { this.settings.supplements.push(newSupp); this.updateSettings(); } },

            handleImageCompress(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        this.form.excretion.imageBase64 = canvas.toDataURL('image/jpeg', 0.5);
                    }
                    img.onerror = () => { alert("ç„¡æ³•è®€å–åœ–ç‰‡"); }
                }
            },

            // --- æ–°å¢ï¼šé–‹å•Ÿç·¨è¼¯è¦–çª— ---
            openEditModal(record) {
                // æ·±æ‹·è²è³‡æ–™ï¼Œé¿å…ç›´æ¥ä¿®æ”¹åˆ°ç•«é¢é¡¯ç¤º
                this.editForm = JSON.parse(JSON.stringify(record));
                this.isEditModalOpen = true;
            },

            // --- æ–°å¢ï¼šæäº¤ç·¨è¼¯ä¿®æ”¹ (åŒæ­¥ Firebase) ---
            async submitEdit() {
                try {
                    this.isLoading = true;
                    // æ ¹æ“šä¸åŒçš„è³‡æ–™é¡å‹ï¼Œæ•´ç†è¦æ›´æ–°çš„æ¬„ä½
                    // ç‰¹åˆ¥æ³¨æ„ï¼šå¦‚æœæ˜¯ç”¨é¤ç´€éŒ„ï¼Œè¦ç¢ºä¿ timestamp è·Ÿ startTime ä¿æŒä¸€è‡´
                    if (this.editForm.category === 'food') {
                         this.editForm.timestamp = this.editForm.data.startTime; 
                    } else if (this.editForm.category === 'excretion') {
                         this.editForm.timestamp = this.editForm.data.datetime;
                    } else if (this.editForm.category === 'meds') {
                         // é©…èŸ²çš„ timestamp ä¿æŒä¸è®Šï¼Œæˆ–ä¹Ÿå¯ä»¥è¨­ç‚º date
                    }

                    await updateDoc(doc(db, "records", this.editForm.id), {
                        timestamp: this.editForm.timestamp,
                        data: this.editForm.data
                    });
                    
                    this.isEditModalOpen = false;
                    // alert("ä¿®æ”¹æˆåŠŸï¼"); // æ‰‹æ©Ÿä¸Šå¯ä»¥ä¸è·³ alert æ¯”è¼ƒé †æš¢
                } catch (e) {
                    alert("ä¿®æ”¹å¤±æ•—ï¼š" + e.message);
                } finally {
                    this.isLoading = false;
                }
            },

            async submitExcretion() {
                try {
                    this.isLoading = true;
                    await addDoc(collection(db, "records"), {
                        category: 'excretion',
                        timestamp: this.form.excretion.datetime,
                        data: { ...this.form.excretion }
                    });
                    this.form.excretion.imageBase64 = null;
                    this.form.excretion.datetime = getCurrentDateTime();
                    this.currentTab = 'history';
                } catch (error) { alert("å„²å­˜å¤±æ•—ï¼\n" + error.message); } finally { this.isLoading = false; }
            },

            async submitServeFood() {
                if (!this.form.food.amountGiven) return alert('è«‹è¼¸å…¥é‡é‡');
                try {
                    await addDoc(collection(db, "records"), {
                        category: 'food',
                        timestamp: this.form.food.datetime,
                        data: { status: 'eating', startTime: this.form.food.datetime, endTime: null, type: this.form.food.type, brand: this.form.food.brand, amountGiven: this.form.food.amountGiven, amountLeft: null, supplements: [...this.form.food.supplements] }
                    });
                    this.form.food.amountGiven = ''; this.form.food.supplements = [];
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } catch (e) { alert("éŒ¯èª¤ï¼š" + e.message); }
            },
            async submitLeftover() {
                if (!this.activeMeal) return;
                const now = new Date(); const [h, m] = this.form.leftover.time.split(':'); now.setHours(h, m);
                try {
                    await updateDoc(doc(db, "records", this.activeMeal.id), { "data.status": "finished", "data.endTime": now.toISOString(), "data.amountLeft": this.form.leftover.amount });
                    this.currentTab = 'history';
                } catch (e) { alert("éŒ¯èª¤ï¼š" + e.message); }
            },
            async quickFinish(id) {
                if(!confirm('ç¢ºå®šè¦ç›´æ¥çµç®—å—ï¼Ÿ')) return;
                try {
                    await updateDoc(doc(db, "records", id), { "data.status": "finished", "data.endTime": new Date().toISOString(), "data.amountLeft": 0 });
                } catch (e) { alert("éŒ¯èª¤ï¼š" + e.message); }
            },
            async submitMeds() {
                try {
                    await addDoc(collection(db, "records"), { category: 'meds', timestamp: new Date().toISOString(), data: { ...this.form.meds } });
                    this.form.meds.brand = ''; this.currentTab = 'history';
                } catch (e) { alert("éŒ¯èª¤ï¼š" + e.message); }
            },
            async deleteRecord(id) {
                if(!confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
                try { await deleteDoc(doc(db, "records", id)); } catch (e) { alert("åˆªé™¤å¤±æ•—ï¼š" + e.message); }
            }
        }
    }).mount('#app');
</script>
</body>
</html>